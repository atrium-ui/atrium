stages:
  - test
  - publish
  - library

image: luckydye/buildapp

variables:
  RTX_DATA_DIR: $CI_PROJECT_DIR/.rtx
  GIT_PUSH_TOKEN: $GIT_PUSH_TOKEN # A Gitlab access token to push to the repo

cache:
  - key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
  - key:
      files:
        - .rtx.toml
    paths:
      - .rtx

before_script:
  - export PATH=$RTX_DATA_DIR/shims:$PATH
  - task setup
  - git config user.email "gitlab@s-v.de"
  - git config user.name "CI"
  - git remote set-url origin https://oauth2:$GIT_PUSH_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git

publish:
  stage: publish
  only:
      - main
  when: manual
  script: task publish

publish-dev:
  stage: publish
  only:
      - develop
  when: manual
  script: task publish-dev

docs:
  stage: library
  script: task build:library
  environment:
    name: main
    url: https://a-components.pages.s-v.de/mono
  only:
    - tags
  except:
    - branches
  when: manual
  artifacts:
    paths:
      - public

docs-dev:
    stage: library
    script: task build:library
    environment:
        name: develop
        url: "https://a-components.pages.s-v.de/-/$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/artifacts/public/index.html"
    only:
      - develop
    artifacts:
        paths:
          - public
    variables:
        PUBLIC_URL: "/-/$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/artifacts/public"

test:
  stage: test
  script: task test

stages:
  - test
  - publish
  - library

publish:
  stage: publish
  image: node:18-buster
  only:
      - main
  when: manual
  variables:
    GITLAB_NPM_REGISTRY_TOKEN: ${CI_JOB_TOKEN}
  before_script:
    - npm i -g pnpm
    - pnpm config set store-dir .pnpm-store
    - git config user.email "gitlab@s-v.de"
    - git config user.name "CI"
    - git remote set-url origin https://oauth2:$GIT_PUSH_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git
  script:
    - pnpm i
    - pnpm build
    - npm version patch
    - npm publish
    - git push --tags -o ci.skip
    - git push origin HEAD:main -o ci.skip
    - git push origin HEAD:develop -o ci.skip

publish-dev:
  stage: publish
  image: node:18-buster
  only:
      - develop
  when: manual
  variables:
    GITLAB_NPM_REGISTRY_TOKEN: ${CI_JOB_TOKEN}
  before_script:
    - npm i -g pnpm
    - pnpm config set store-dir .pnpm-store
    - git config user.email "gitlab@s-v.de"
    - git config user.name "CI"
    - git remote set-url origin https://oauth2:$GIT_PUSH_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git
  script:
    - pnpm i
    - pnpm build
    - npm version prerelease
    - npm publish --tag dev
    - git push origin --tags -o ci.skip
    - git push origin HEAD:develop -o ci.skip

docs:
  stage: library
  image: node:18-buster
  before_script:
    - npm i -g pnpm
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install # install dependencies
    - pnpm build
    - pnpm library:build
    - mv apps/library/dist public
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
  only:
    - tags
  except:
    - branches
  when: manual
  environment:
    name: main
    url: https://a-components.pages.s-v.de/mono
  artifacts:
    paths:
      - public

docs-dev:
    environment:
        name: develop
        url: "https://a-components.pages.s-v.de/-/$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/artifacts/public/index.html"
    stage: library
    image: node:18-buster
    before_script:
      - npm i -g pnpm
      - pnpm config set store-dir .pnpm-store
    script:
      - pnpm install # install dependencies
      - pnpm build
      - pnpm library:build
      - mv apps/library/dist public
    only:
      - develop
    cache:
      key:
        files:
          - pnpm-lock.yaml
      paths:
        - .pnpm-store
    artifacts:
        paths:
          - public
    variables:
        PUBLIC_URL: "/-/$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/artifacts/public"

test:
  stage: test
  image: node:18-buster
  before_script:
    - npm i -g pnpm
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm i
    - pnpm build
    - pnpm test

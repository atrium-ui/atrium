stages:
  - library
  - publish

pages:
  stage: library
  image: node:18-buster
  before_script:
    - curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm@7
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install # install dependencies
    - pnpm build
    - mv apps/library/dist public
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
  only:
    - tags
  except:
    - branches
  when: manual
  environment:
    name: pages
    url: https://sv-components.pages.s-v.de/
  artifacts:
    paths:
      - public

publish:
  stage: publish
  image: node:18-buster
  only:
    - tags
  except:
    - branches
  variables:
    GITLAB_NPM_REGISTRY_TOKEN: ${CI_JOB_TOKEN}
  before_script:
    - curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm@7
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm i
    - pnpm build
    - npm publish

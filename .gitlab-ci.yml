stages:
  - test
  - merge
  - publish
  - docs

image: luckydye/atrium:latest

variables:
  MISE_DATA_DIR: $CI_PROJECT_DIR/.mise
  MISE_VERBOSE: 1
  GIT_PUSH_TOKEN: $GIT_PUSH_TOKEN # A Gitlab access token to push to the repo

before_script:
  - export PATH=$MISE_DATA_DIR/shims:$PATH
  - mise install
  - git config user.email "gitlab@s-v.de"
  - git config user.name "CI"
  - git remote set-url origin https://oauth2:$GIT_PUSH_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git

check:
  stage: test
  except:
    - tags
  only:
    - merge_requests
    - /^release\/.+$/
    - main
  script: task check

test:
  stage: test
  except:
    - tags
  only:
    - merge_requests
    - /^release\/.+$/
    - main
  script: task test

a11y:
  allow_failure: true
  stage: test
  artifacts:
    paths:
      - packages/a11y/.reports
    untracked: true
  except:
    - tags
  only:
    - merge_requests
    - /^release\/.+$/
    - main
  script:
    - apt update -y
    - apt install -y ca-certificates fonts-liberation libasound2 libatk-bridge2.0-0 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 lsb-release wget xdg-utils
    - task a11y

merge_release_preview:
  stage: merge
  only:
    - merge_requests
  script: task release:preview

publish-dev:
  stage: publish
  only:
    - /^release\/.+$/
  script:
    - git checkout "$CI_COMMIT_REF_NAME"
    - git fetch --prune --prune-tags -f
    - git pull
    - bun x npm config set //gitlab.s-v.de/api/v4/projects/1560/packages/npm/:_authToken="$CI_JOB_TOKEN"
    - bun x npm config list
    - task prerelease

publish:
  stage: publish
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
      when: on_success
    - when: never
  script:
    - git checkout "$CI_COMMIT_REF_NAME"
    - git fetch --prune --prune-tags -f
    - git pull
    - bun x npm config set //gitlab.s-v.de/api/v4/projects/1560/packages/npm/:_authToken="$CI_JOB_TOKEN"
    - bun x npm config list
    - task release

pages:
  stage: docs
  dependencies:
    - a11y
    - publish
  only:
    - main
  environment:
    name: docs
    url: https://svp.pages.s-v.de/atrium
  artifacts:
    paths:
      - public
  script: task docs:build

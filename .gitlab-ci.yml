stages:
  - lint
  - test
  - publish
  - docs

image: luckydye/build-utils

variables:
  RTX_DATA_DIR: $CI_PROJECT_DIR/.rtx
  GIT_PUSH_TOKEN: $GIT_PUSH_TOKEN # A Gitlab access token to push to the repo

cache:
  - key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
  - key:
      files:
        - .rtx.toml
    paths:
      - .rtx

before_script:
  - apt install unzip -y
  - export PATH=$RTX_DATA_DIR/shims:$PATH
  - rtx install
  - task setup
  - git config user.email "gitlab@s-v.de"
  - git config user.name "CI"
  - git remote set-url origin https://oauth2:$GIT_PUSH_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git

test:
  stage: test
  except:
    - tags
  script: task test

lint:
  stage: lint
  except:
    - tags
  script: task lint

format:
  script:
    - task fix
    - 'git commit -a "ci: format"'
    - "git push origin HEAD:$CI_COMMIT_REF_NAME"
  only:
    - merge_requests

publish-minor:
  stage: publish
  only:
    - main
  when: manual
  script:
    - task publish type=minor tag=latest

publish-patch:
  stage: publish
  only:
    - main
  when: manual
  script:
    - task publish type=patch tag=latest

publish-dev:
  stage: publish
  only:
    - develop
  script:
    - task publish type=prerelease tag=dev

pages:
  stage: docs
  only:
    - main
    - docs
  environment:
    name: docs
    url: https://sv-components.pages.s-v.de/mono
  artifacts:
    paths:
      - public
  script: task docs:build

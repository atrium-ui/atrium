stages:
  - check
  - test
  - publish
  - docs

image: debian:stable

variables:
  MISE_DATA_DIR: $CI_PROJECT_DIR/.mise
  GIT_PUSH_TOKEN: $GIT_PUSH_TOKEN # A Gitlab access token to push to the repo

cache:
  - key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
  - key:
      files:
        - .mise.toml
    paths:
      - .mise

before_script:
  - apt update -y && apt install curl git unzip -y
  - curl https://mise.jdx.dev/install.sh | MISE_INSTALL_PATH=/usr/local/bin/mise sh
  - export PATH=$MISE_DATA_DIR/shims:$PATH
  - sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
  - task setup:ci

check:
  stage: check
  except:
    - tags
  script: task check

test:
  stage: test
  artifacts:
    untracked: true
  except:
    - tags
  script: task test

format:
  only:
    - merge_requests
  script: task format

publish:
  stage: publish
  dependencies:
    - test
  only:
    - main
  rules:
    - if: $CI_COMMIT_REF_NAME =~ "/^release/"
      when: never
  script: task publish

pages:
  stage: docs
  only:
    - main
    - develop # for preview
  environment:
    name: docs
    url: https://sv.pages.s-v.de/sv-frontend-library/mono
  artifacts:
    paths:
      - public
  script: task docs:build
